<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading & To-Do Hub</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Fonts and Base Layout */
        body {
            background-color: #F8F7F4; /* Off-white background */
            color: #2c3e50; /* Charcoal text */
            font-family: 'Cormorant Garamond', serif;
            min-height: 100vh;
        }
        .text-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .charcoal-text {
            color: #2c3e50;
        }
        .drag-source {
            opacity: 0.4;
        }
        /* Custom scrollbar for aesthetics */
        .list-container::-webkit-scrollbar {
            width: 8px;
        }
        .list-container::-webkit-scrollbar-thumb {
            background-color: #bdc3c7;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-track {
            background: #F8F7F4;
        }

        /* DND Placeholder for visual feedback */
        .drag-over-indicator {
            border-top: 2px solid #3498db;
            margin-top: -2px;
            height: 0;
        }

        /* Style for drag feedback on the body (for PDFs) */
        .file-drag-active {
            box-shadow: 0 0 0 4px #3498db inset;
        }

        /* NEW CSS FOR SUB-TASK VISUALS */
        .subtask-container {
            position: relative;
        }
        .subtask-container::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 0;
            bottom: 0.5rem;
            width: 2px;
            background-color: #e0e0e0;
        }
        .subtask-item {
            position: relative;
        }
        .subtask-item::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 0.9rem; /* Adjusted for smaller sub-task height */
            width: 0.75rem;
            height: 2px;
            background-color: #e0e0e0;
        }
    </style>
    <script>
        // Tailwind Configuration for custom colors and fonts
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'off-white': '#F8F7F4',
                        'charcoal': '#2c3e50',
                        'primary-blue': '#3498db', /* for accents/buttons */
                        'primary-green': '#2ecc71', /* for todo accents */
                    },
                    fontFamily: {
                        garamond: ['Cormorant Garamond', 'serif'],
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    maxWidth: {
                        '7xl': '1280px', // Increased max-width for dual pane
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto w-full flex justify-end mb-4 px-4 sm:px-6">
        <button id="auth-toggle-btn" 
                class="text-poppins text-xs font-semibold py-2 px-4 rounded-full bg-charcoal text-white hover:bg-gray-700 transition duration-200"
                onclick="openAuthModal()">
            Login / Sign Up
        </button>
    </div>

    <div id="app" class="max-w-7xl mx-auto w-full p-0">
        <h1 class="text-4xl sm:text-5xl font-garamond font-bold mb-8 text-center border-b pb-4 px-4 sm:px-6">
            Productivity Hub
        </h1>

        <div id="loading" class="flex justify-center items-center py-10" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue"></div>
            <p class="ml-3 text-poppins text-charcoal">Connecting to Supabase...</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 sm:p-6">
            
            <div id="reading-column" class="bg-white rounded-xl shadow-lg p-6 lg:col-span-1 flex flex-col">
                <h2 class="text-3xl font-garamond font-bold mb-4 text-center">Reading List</h2>

                <div id="reading-list" class="list-container flex-grow max-h-[60vh] overflow-y-auto space-y-2 mb-4 p-2 border-b border-gray-100">
                    </div>

                <div class="h-[1.75rem] mb-4 mt-auto"></div> 
                
                <form id="add-reading-form" class="flex space-x-2 pt-4">
                    <input type="text" id="new-reading-text" placeholder="Author (Year): *Title* or drag a PDF"
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue text-poppins charcoal-text">
                    <button type="submit"
                            class="text-poppins font-semibold bg-primary-blue text-white rounded-lg px-4 py-3 shadow-md hover:bg-blue-600 transition duration-200 whitespace-nowrap">
                        Add Text
                    </button>
                </form>
            </div>

            <div id="todo-column" class="bg-white rounded-xl shadow-lg p-6 lg:col-span-1 flex flex-col">
                <h2 class="text-3xl font-garamond font-bold mb-4 text-center">To-Do List</h2>

                <div id="todo-list" class="list-container flex-grow max-h-[60vh] overflow-y-auto space-y-2 mb-4 p-2 border-b border-gray-100">
                    </div>

                <div class="h-[1.75rem] mb-4 mt-auto"></div> 
                
                <form id="add-todo-form" class="flex space-x-2 pt-4">
                    <input type="text" id="new-todo-text" placeholder="Buy milk, Study for class, etc."
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-poppins charcoal-text">
                    <button type="submit"
                            class="text-poppins font-semibold bg-primary-green text-white rounded-lg px-4 py-3 shadow-md hover:bg-green-600 transition duration-200 whitespace-nowrap">
                        Add Task
                    </button>
                </form>
            </div>

        </div>
        <div id="message-area" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
            <div id="message-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center text-poppins">
                <p class="charcoal-text font-semibold mb-4" id="modal-text">Error</p>
                <button onclick="closeModal()" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">OK</button>
            </div>
        </div>

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-poppins">
                <h3 class="text-2xl font-bold mb-6 text-center">Sync Across Devices</h3>
                <form id="auth-form" onsubmit="handleAuthSubmit(event)">
                    <p id="auth-message" class="text-sm text-center text-red-500 mb-4"></p>
                    <input type="email" id="auth-email" placeholder="Email" required
                           class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue">
                    <input type="password" id="auth-password" placeholder="Password" required
                           class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue">
                    
                    <button type="submit" id="auth-action-btn"
                            class="w-full bg-primary-blue text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-600 transition duration-200">
                        Log In
                    </button>
                    <button type="button" onclick="closeAuthModal()"
                            class="w-full mt-3 text-sm text-gray-600 py-2 hover:text-charcoal transition">
                        Cancel
                    </button>
                </form>
            </div>
        </div>

    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = "https://phpmhqfdbcbpidkohmdx.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBocG1ocWZkYmNicGlka29obWR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTAzOTksImV4cCI6MjA3NDk4NjM5OX0.taS3tmL_OhJ2ubtCthp2HfLV6-1HvfjuU32aekK_kdQ"; 
        
        const SUPABASE_TABLE_READING = 'reading_list';
        const SUPABASE_TABLE_TODOS = 'todos'; 

        let supabase = null;
        let userId = null; 
        
        let readingList = []; 
        let todoList = []; 

        const readingListElement = document.getElementById('reading-list');
        const todoListElement = document.getElementById('todo-list');
        const loadingElement = document.getElementById('loading');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        
        // --- Initialization and Auth ---

        async function initializeSupabase() {
            loadingElement.style.display = 'flex';
            if (SUPABASE_URL.includes("YOUR_SUPABASE_URL")) {
                showModal("Please update the Supabase configuration with your project keys.");
                loadingElement.style.display = 'none';
                return;
            }

            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                supabase.auth.onAuthStateChange((event, session) => {
                    const wasLoggedIn = !!userId;
                    const isLoggedIn = !!session?.user;

                    if (isLoggedIn) {
                        userId = session.user.id; 
                        updateAuthButton(false, session.user.email);
                        updateFormState(true);
                        if (!wasLoggedIn) {
                            setupRealtimeListener(SUPABASE_TABLE_READING);
                            setupRealtimeListener(SUPABASE_TABLE_TODOS);
                        }
                    } else {
                        userId = null;
                        updateAuthButton(true, null);
                        updateFormState(false);
                        readingList = [];
                        todoList = [];
                        renderAllLists();
                        loadingElement.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Supabase initialization failed:", error);
                showModal("Failed to connect to Supabase. Check console for details.");
                loadingElement.style.display = 'none';
            }
        }

        function updateAuthButton(isLoggedOut, email) {
            if (isLoggedOut) {
                authToggleBtn.textContent = 'Login';
                authToggleBtn.onclick = openAuthModal;
            } else {
                authToggleBtn.textContent = `Logged in as ${email}`;
                authToggleBtn.onclick = () => handleLogout();
            }
        }
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const authMsg = document.getElementById('auth-message');
            authMsg.textContent = '';

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                authMsg.textContent = error.message;
            } else {
                closeAuthModal();
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Logout error:", error);
                showModal("Error logging out.");
            }
        }

        function updateFormState(isLoggedIn) {
            const readingInput = document.getElementById('new-reading-text');
            const readingButton = document.querySelector('#add-reading-form button');
            const todoInput = document.getElementById('new-todo-text');
            const todoButton = document.querySelector('#add-todo-form button');

            const inputs = [readingInput, readingButton, todoInput, todoButton];
            inputs.forEach(el => el.disabled = !isLoggedIn);

            readingInput.placeholder = isLoggedIn ? "Author (Year): *Title* or drag a PDF" : "Please log in to add items";
            todoInput.placeholder = isLoggedIn ? "Buy milk, Study for class, etc." : "Please log in to add items";
        }

        window.openAuthModal = function() {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('auth-email').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-message').textContent = '';
        }

        window.closeAuthModal = function() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        window.showModal = function(message) {
            document.getElementById('modal-text').textContent = message;
            document.getElementById('message-area').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('message-area').style.display = 'none';
        }

        function parsePdfFilename(filename) {
            const baseName = filename.replace(/\.pdf$/i, '').trim();
            const match = baseName.match(/^(.+)_(\d{4})_(.+)$/);
            if (match) {
                const author = match[1].replace(/_/g, ' ').trim();
                const year = match[2];
                let title = match[3].replace(/_/g, ' ').trim();
                title = title.charAt(0).toUpperCase() + title.slice(1);
                return `${author} (${year}): *${title}*`;
            }
            return baseName; 
        }
        
        function getListResources(tableName) {
            if (tableName === SUPABASE_TABLE_READING) {
                return { list: readingList, element: readingListElement, emptyMessage: 'Your reading list is empty.', primaryColor: 'primary-blue', itemFontSize: 'text-lg' };
            } else if (tableName === SUPABASE_TABLE_TODOS) {
                return { list: todoList, element: todoListElement, emptyMessage: 'You have no tasks!', primaryColor: 'primary-green', itemFontSize: 'text-xl' };
            }
            return null;
        }

        async function fetchAndRenderList(tableName) {
            if (!userId) {
                loadingElement.style.display = 'none';
                renderAllLists();
                return; 
            }
            
            const { data, error } = await supabase
                .from(tableName)
                .select('*')
                .eq('user_id', userId) 
                .order('order', { ascending: true }); 

            if (error) {
                console.error(`Supabase fetch failed for ${tableName}:`, error);
                showModal(`Could not load ${tableName}. Check RLS policies.`);
                loadingElement.style.display = 'none';
                return;
            }

            const sortedData = data.sort((a, b) => a.completed - b.completed || a.order - b.order);

            if (tableName === SUPABASE_TABLE_READING) {
                readingList = sortedData;
            } else {
                todoList = sortedData;
            }
            renderAllLists();
            loadingElement.style.display = 'none';
        }
        
        function setupRealtimeListener(tableName) {
            if (!userId) return; 
            
            const existingChannel = supabase.getChannels().find(c => c.topic.includes(tableName));
            if (existingChannel) supabase.removeChannel(existingChannel);
            
            supabase.channel(`changes-${tableName}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: tableName, filter: `user_id=eq.${userId}` },
                    () => fetchAndRenderList(tableName)
                )
                .subscribe(status => {
                    if (status === 'SUBSCRIBED') {
                        fetchAndRenderList(tableName);
                    }
                });
        }
        
        function renderAllLists() {
            renderReadingList();
            renderTodoList();
        }

        function renderReadingList() {
            const resources = getListResources(SUPABASE_TABLE_READING);
            const { list, element, emptyMessage, primaryColor, itemFontSize } = resources;
            element.innerHTML = '';
            
            if (list.length === 0 && userId) {
                element.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">${emptyMessage}</p>`;
                return;
            }

            list.forEach((item) => {
                const li = document.createElement('div');
                li.id = `${SUPABASE_TABLE_READING}-${item.id}`;
                const completedStyle = item.completed ? 'bg-gray-100 opacity-70 cursor-default' : 'bg-off-white hover:shadow-md cursor-pointer';
                li.className = `flex items-center p-3 rounded-xl shadow-sm border border-gray-200 transition-shadow ${completedStyle}`;
                li.setAttribute('draggable', !item.completed);
                li.dataset.id = item.id;
                li.dataset.order = item.order;
                li.dataset.table = SUPABASE_TABLE_READING;
                
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragenter', handleDragEnter);
                li.addEventListener('dragleave', handleDragLeave);
                li.addEventListener('dragend', handleDragEnd);

                const textSpan = document.createElement('span');
                textSpan.className = `flex-grow mr-4 ${itemFontSize} font-garamond ${item.completed ? 'line-through text-gray-500' : 'charcoal-text'}`;
                textSpan.innerHTML = item.text.replace(/\*(.*?)\*/g, '<em>$1</em>');

                const toggleButton = document.createElement('button');
                const toggleButtonClasses = item.completed 
                    ? `p-3 h-8 w-8 flex items-center justify-center rounded-full text-white bg-${primaryColor}`
                    : `p-3 h-8 w-8 flex items-center justify-center rounded-full text-gray-400 border-2 border-gray-300 hover:border-${primaryColor} hover:text-${primaryColor}`;
                toggleButton.className = `mr-2 ${toggleButtonClasses} transition-colors`;
                toggleButton.innerHTML = item.completed ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>` : `<span></span>`;
                toggleButton.onclick = () => toggleCompleted(SUPABASE_TABLE_READING, item.id, !item.completed);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'p-3 h-8 w-8 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-gray-200 transition';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-5 3h14" /></svg>`;
                deleteButton.onclick = () => deleteItem(SUPABASE_TABLE_READING, item.id);

                li.append(textSpan, toggleButton, deleteButton);
                element.appendChild(li);
            });
        }
        
        function renderTodoList() {
            const resources = getListResources(SUPABASE_TABLE_TODOS);
            const { list, element, emptyMessage } = resources;
            element.innerHTML = '';

            if (list.length === 0 && userId) {
                element.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">${emptyMessage}</p>`;
                return;
            }

            const todoMap = new Map();
            const orphans = [];
            list.forEach(item => {
                if (!item.parent_id) {
                    todoMap.set(item.id, { ...item, children: [] });
                }
            });
            list.forEach(item => {
                if (item.parent_id) {
                    if (todoMap.has(item.parent_id)) {
                        todoMap.get(item.parent_id).children.push(item);
                    } else {
                        orphans.push(item); 
                    }
                }
            });

            const allTopLevelTodos = [...todoMap.values(), ...orphans.map(o => ({...o, children: []}))];
            allTopLevelTodos.sort((a,b) => a.order - b.order);

            allTopLevelTodos.forEach(mainTodo => {
                const li = createTodoElement(mainTodo, SUPABASE_TABLE_TODOS, false);
                
                const subtaskContainer = document.createElement('div');
                subtaskContainer.className = 'pl-8 mt-1 space-y-1 subtask-container';
                subtaskContainer.id = `subtasks-of-${mainTodo.id}`;

                mainTodo.children.sort((a,b) => a.order - b.order).forEach(subtask => {
                    const subtaskLi = createTodoElement(subtask, SUPABASE_TABLE_TODOS, true);
                    subtaskContainer.appendChild(subtaskLi);
                });

                li.appendChild(subtaskContainer);
                element.appendChild(li);
            });
        }

        function createTodoElement(item, tableName, isSubtask) {
            const resources = getListResources(tableName);
            const { primaryColor, itemFontSize } = resources;

            const li = document.createElement('div');
            li.id = `${tableName}-${item.id}`;
            
            // --- NEW --- Updated styling for sub-tasks
            let containerClasses = `flex items-center rounded-xl border border-gray-200 transition-shadow duration-300`;
            if (isSubtask) {
                containerClasses += ` p-2 bg-white`;
            } else {
                containerClasses += ` p-3 shadow-sm bg-off-white hover:shadow-md`;
            }
            if (item.completed) {
                containerClasses += ` opacity-50`;
            }
            li.className = containerClasses;
            li.dataset.id = item.id;

            const toggleButton = document.createElement('button');
            const sizeClasses = isSubtask ? 'h-5 w-5' : 'h-6 w-6'; // smaller button for subtask
            const toggleButtonClasses = item.completed 
                ? `flex items-center justify-center rounded-full text-white bg-${primaryColor}`
                : `flex items-center justify-center rounded-full text-gray-400 border-2 border-gray-300 hover:border-${primaryColor}`;
            toggleButton.className = `mr-3 ${sizeClasses} ${toggleButtonClasses} transition-colors`;
            toggleButton.innerHTML = item.completed ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>` : `<span></span>`;
            toggleButton.onclick = () => toggleCompleted(tableName, item.id, !item.completed);

            const textSpan = document.createElement('span');
            const textFontSize = isSubtask ? 'text-base' : itemFontSize; // smaller text for subtask
            textSpan.className = `flex-grow ${textFontSize} font-garamond ${item.completed ? 'line-through text-gray-500' : 'charcoal-text'}`;
            textSpan.textContent = item.text;

            const deleteButton = document.createElement('button');
            deleteButton.className = 'ml-auto p-2 h-7 w-7 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-gray-100 transition';
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
            deleteButton.onclick = () => deleteItem(tableName, item.id);

            li.append(toggleButton, textSpan);
            
            if (isSubtask) {
                li.classList.add('subtask-item');
            }

            if (!isSubtask && !item.completed) {
                const addSubtaskButton = document.createElement('button');
                addSubtaskButton.className = 'ml-2 p-2 h-8 w-8 flex items-center justify-center rounded-full text-gray-400 hover:text-blue-500 hover:bg-gray-100 transition';
                addSubtaskButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;
                addSubtaskButton.onclick = (e) => {
                    e.stopPropagation();
                    showAddSubtaskInput(item.id);
                };
                li.append(addSubtaskButton);
            }
            
            li.append(deleteButton);
            return li;
        }

        function showAddSubtaskInput(parentId) {
            const existingInput = document.getElementById('temp-subtask-input-container');
            if (existingInput) existingInput.remove();

            const container = document.getElementById(`subtasks-of-${parentId}`);
            if (!container) return;

            const inputContainer = document.createElement('div');
            inputContainer.id = 'temp-subtask-input-container';
            inputContainer.className = 'p-2 flex items-center space-x-2';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Add new sub-task...';
            input.className = 'flex-grow p-2 border border-gray-300 rounded-lg text-poppins text-sm';
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'text-poppins text-sm font-semibold bg-primary-blue text-white rounded-lg px-3 py-2';
            saveButton.onclick = () => {
                if (input.value.trim()) {
                    addItem(SUPABASE_TABLE_TODOS, input.value, parentId);
                    inputContainer.remove();
                }
            };
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveButton.click();
                if (e.key === 'Escape') inputContainer.remove();
            });

            inputContainer.append(input, saveButton);
            container.appendChild(inputContainer);
            input.focus();
        }

        async function addItem(tableName, text, parentId = null) {
            if (!supabase || !userId || !text.trim()) return;
            
            const currentList = tableName === SUPABASE_TABLE_TODOS ? todoList : readingList;
            
            const itemsToOrder = parentId 
                ? currentList.filter(item => item.parent_id === parentId)
                : currentList.filter(item => !item.parent_id);

            const newOrder = itemsToOrder.length > 0 ? Math.max(...itemsToOrder.map(i => i.order || 0)) + 1 : 1;
            
            const itemToAdd = {
                user_id: userId, 
                text: text.trim(),
                completed: false,
                order: newOrder,
            };

            if (tableName === SUPABASE_TABLE_TODOS) {
                itemToAdd.parent_id = parentId;
            }

            const { data: newData, error } = await supabase
                .from(tableName)
                .insert(itemToAdd)
                .select()
                .single();

            if (error) {
                console.error(`Error adding item to ${tableName}: `, error);
                showModal(`Failed to add item. Check RLS policies.`);
            } else {
                if (tableName === SUPABASE_TABLE_READING) {
                    readingList.push(newData);
                    document.getElementById('new-reading-text').value = '';
                } else {
                    todoList.push(newData);
                    if (!parentId) {
                        document.getElementById('new-todo-text').value = '';
                    }
                }
                renderAllLists();
            }
        }

        async function toggleCompleted(tableName, id, status) {
            if (!supabase || !userId) return;

            const { error } = await supabase
                .from(tableName)
                .update({ completed: status })
                .eq('id', id);

            if (error) {
                showModal("Failed to update item status.");
            } else {
                // --- NEW --- Locally update the item's status
                const listToUpdate = tableName === SUPABASE_TABLE_READING ? readingList : todoList;
                const itemIndex = listToUpdate.findIndex(item => item.id === id);
                if (itemIndex > -1) {
                    listToUpdate[itemIndex].completed = status;

                    // Also update children if a parent is toggled
                    if (tableName === SUPABASE_TABLE_TODOS && !listToUpdate[itemIndex].parent_id) {
                        todoList.forEach(item => {
                            if (item.parent_id === id) {
                                item.completed = status;
                            }
                        });
                    }
                }
                renderAllLists();
            }
        }

        async function deleteItem(tableName, id) {
            if (!supabase || !userId) return;
            const { error } = await supabase.from(tableName).delete().eq('id', id);
            if (error) {
                showModal("Failed to delete item.");
            } else {
                if (tableName === SUPABASE_TABLE_READING) {
                    readingList = readingList.filter(item => item.id !== id);
                } else {
                    // Also delete children from local state
                    const childrenIds = todoList.filter(item => item.parent_id === id).map(child => child.id);
                    todoList = todoList.filter(item => item.id !== id && !childrenIds.includes(item.id));
                }
                renderAllLists();
            }
        }

        async function updateItemOrder(tableName, newOrderList) {
            if (!supabase || !userId) return;
            const updates = newOrderList.filter(item => !item.completed).map((item, index) => ({ id: item.id, order: index + 1 }));
            const { error } = await supabase.from(tableName).upsert(updates);
            if (error) showModal("Failed to save new list order.");
        }

        // --- Drag and Drop Logic ---
        let draggedItem = null;
        let originalParent = null;

        function handleDragStart(e) {
            if (this.getAttribute('draggable') === 'false') {
                e.preventDefault(); return;
            }
            draggedItem = this;
            originalParent = this.parentNode;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            setTimeout(() => this.classList.add('drag-source'), 0);
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = this;
            if (target === draggedItem || target.dataset.id === undefined || target.classList.contains('bg-gray-100') || target.dataset.table !== draggedItem.dataset.table) {
                return;
            }
            originalParent.querySelectorAll('.drag-over-indicator').forEach(el => el.remove());
            const indicator = document.createElement('div');
            indicator.className = 'drag-over-indicator';
            indicator.style.borderColor = target.dataset.table === SUPABASE_TABLE_TODOS ? '#2ecc71' : '#3498db';
            
            const rect = target.getBoundingClientRect();
            if (e.clientY - rect.top < rect.height / 2) {
                originalParent.insertBefore(indicator, target);
            } else {
                originalParent.insertBefore(indicator, target.nextSibling);
            }
        }

        function handleDragLeave() { /* Handled by dragEnter cleanup */ }
        
        function handleDragEnd() {
            this.classList.remove('drag-source');
            if (originalParent) {
                originalParent.querySelectorAll('.drag-over-indicator').forEach(el => el.remove());
                const children = Array.from(originalParent.children).filter(el => el.dataset.id);
                const tableName = originalParent.id === 'reading-list' ? SUPABASE_TABLE_READING : SUPABASE_TABLE_TODOS;
                const currentList = tableName === SUPABASE_TABLE_READING ? readingList : todoList;
                const newOrderList = children.map(domEl => currentList.find(item => item.id.toString() === domEl.dataset.id));
                updateItemOrder(tableName, newOrderList);
            }
            draggedItem = null;
            originalParent = null;
        }

        [readingListElement, todoListElement].forEach(listEl => {
            listEl.addEventListener('dragover', (e) => {
                e.preventDefault(); e.dataTransfer.dropEffect = 'move';
            });
            listEl.addEventListener('drop', (e) => {
                e.preventDefault();
                const indicator = listEl.querySelector('.drag-over-indicator');
                if (draggedItem && indicator && indicator.parentNode === listEl) {
                    indicator.insertAdjacentElement('beforebegin', draggedItem);
                }
            });
        });

        // --- PDF Drag and Drop Handling ---
        let dragCounter = 0;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        document.body.addEventListener('dragenter', () => {
            dragCounter++; document.body.classList.add('file-drag-active');
        }, false);
        document.body.addEventListener('dragleave', () => {
            dragCounter--; if (dragCounter === 0) document.body.classList.remove('file-drag-active');
        }, false);
        document.body.addEventListener('drop', e => {
            document.body.classList.remove('file-drag-active');
            dragCounter = 0;
            for (const file of e.dataTransfer.files) {
                if (file.type === 'application/pdf') {
                    addItem(SUPABASE_TABLE_READING, parsePdfFilename(file.name)); 
                } else {
                    showModal(`Unsupported file type: ${file.name}. Only PDFs are accepted.`);
                }
            }
        }, false);

        // --- Event Listeners and Initial Load ---
        document.getElementById('add-reading-form').addEventListener('submit', (e) => {
            e.preventDefault();
            addItem(SUPABASE_TABLE_READING, document.getElementById('new-reading-text').value);
        });
        document.getElementById('add-todo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            addItem(SUPABASE_TABLE_TODOS, document.getElementById('new-todo-text').value);
        });

        window.onload = initializeSupabase;

        // --- Expose functions to global scope for HTML event handlers ---
        window.handleAuthSubmit = handleAuthSubmit;
        window.openAuthModal = openAuthModal;
        window.closeAuthModal = closeAuthModal;

    </script>
</body>
</html>