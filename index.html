<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005f9e">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #f0e7d8; /* Parchment-like background */
            color: #1a1a1a; 
        }
        .bauhaus-panel { 
            background-color: #fff;
            border: 3px solid #1a1a1a;
            box-shadow: 8px 8px 0px rgba(0,0,0,1);
        }
        .bauhaus-item { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            padding: 0.75rem 1rem; 
            border-bottom: 2px solid #f0e7d8;
            background-color: #fff; /* Ensure item background is white */
        }
        .bauhaus-item:last-child {
            border-bottom: none;
        }
        .bauhaus-checkbox { 
            width: 1.25rem; 
            height: 1.25rem; 
            border: 2px solid #1a1a1a; 
            flex-shrink: 0; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bauhaus-checkbox.completed { 
            background-color: #1a1a1a; 
            color: white;
        }
        .line-through { 
            text-decoration: line-through; 
            color: #999;
        }
        .color-block {
            padding: 0.5rem 0;
            text-align: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: #1a1a1a;
            border-bottom: 3px solid #1a1a1a;
        }
        .bg-primary-red { background-color: #d92027; }
        .bg-primary-blue { background-color: #005f9e; }
        .bg-primary-yellow { background-color: #f5d90e; }
        .drag-source { opacity: 0.4; }
        .drag-over-indicator { border-top: 3px solid #1a1a1a; margin-top: -3px; height: 0; }
        .file-drag-active { box-shadow: 0 0 0 4px #005f9e inset; }
        .subtask-container { padding-left: 2.5rem; background-color: #faf8f5; padding-top: 0.5rem; padding-bottom: 0.5rem;}
        .subtask-drop-active { background-color: #eaddc7; }
    /* ... all your existing styles ... */
        .subtask-drop-active { background-color: #eaddc7; }

        /* --- ADD THESE NEW RULES --- */
        .bauhaus-item .item-actions {
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .bauhaus-item:hover .item-actions,
        .bauhaus-item .item-actions:focus-within { /* Also show if using keyboard */
            opacity: 1;
        }
    
    /* ... all your existing styles ... */
        .bauhaus-item:hover .item-actions,
        .bauhaus-item .item-actions:focus-within { /* Also show if using keyboard */
            opacity: 1;
        }

        /* --- ADD THESE NEW RULES --- */
        .subtask-toggle-btn {
            opacity: 0.6; /* Makes it 'lighter' by default */
            transition: opacity 0.15s ease-in-out;
        }
        .bauhaus-item:hover .subtask-toggle-btn {
            opacity: 1; /* Makes it fully visible on hover */
        }
    
    /* --- OPTION 3: CHECKBOX SHAPE --- */
.bauhaus-item[data-table="reading_list"] .bauhaus-checkbox {
    border-radius: 50%; /* Makes it a circle */
}
    
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto w-full flex justify-end mb-4 px-4 sm:px-6">
        <button id="auth-toggle-btn" class="font-semibold py-2 px-4 border-2 border-black bg-primary-yellow transition-colors hover:bg-yellow-300">Login</button>
    </div>

    <div id="app" class="max-w-7xl mx-auto w-full p-0">
        <h1 class="text-5xl sm:text-6xl text-center mb-12 sm:mb-16 font-bold">Productivity Hub</h1>
        <div id="loading" class="flex justify-center items-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div><p class="ml-3 font-semibold">Connecting...</p></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 lg:items-start">
            
            <div class="flex flex-col gap-8 lg:gap-12">
                <div id="daily-focus-column" class="bauhaus-panel flex flex-col">
                    <div class="color-block bg-primary-red" style="color: white;">Daily Focus</div>
                    <div id="daily-focus-list" class="list-container flex-grow p-4 space-y-2"></div>
                    <p class="text-center text-sm font-semibold text-gray-600 p-4 border-t-3 border-black">Drag items here to plan your day.</p>
                </div>

                <div id="reading-column" class="bauhaus-panel flex flex-col">
                    <div class="color-block bg-primary-blue" style="color: white;">Reading List</div>
                    <div id="reading-list" class="list-container flex-grow p-4 space-y-2"></div>
                    <form id="add-reading-form" class="flex gap-2 p-4 border-t-3 border-black">
                        <input type="text" id="new-reading-text" placeholder="Add..." class="flex-grow p-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-primary-blue">
                        <button type="submit" class="font-semibold bg-primary-blue text-white p-3 border-2 border-black transition-colors hover:bg-blue-800">Add</button>
                    </form>
                </div>
            </div>

            <div id="todo-column" class="bauhaus-panel flex flex-col">
                <div class="color-block bg-primary-yellow">Task Inbox</div>
                <div id="todo-list" class="list-container flex-grow p-4 space-y-2"></div>
                <form id="add-todo-form" class="flex gap-2 p-4 border-t-3 border-black">
                    <input type="text" id="new-todo-text" placeholder="Add..." class="flex-grow p-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-primary-yellow">
                    <button type="submit" class="font-semibold bg-primary-yellow text-black p-3 border-2 border-black transition-colors hover:bg-yellow-300">Add</button>
                </form>
            </div>

        </div>
    </div>
    <div id="message-area" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;"><div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center font-sans"><p class="font-semibold mb-4" id="modal-text"></p><button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">OK</button></div></div>
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;"><div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full font-sans"><h3 class="text-2xl font-bold mb-6 text-center">Log In</h3><form id="auth-form" onsubmit="handleAuthSubmit(event)"><p id="auth-message" class="text-sm text-center text-red-500 mb-4"></p><input type="email" id="auth-email" placeholder="Email" required class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><input type="password" id="auth-password" placeholder="Password" required class="w-full p-3 mb-6 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition">Log In</button><button type="button" onclick="closeAuthModal()" class="w-full mt-3 text-sm text-gray-600 py-2 hover:text-black transition">Cancel</button></form></div></div>

   <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = "https://uqaxcejfjargwoyvaein.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxYXhjZWpmamFyZ3dveXZhZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxODA5MDEsImV4cCI6MjA3NTc1NjkwMX0.N7fLXEtOhE6cS82KbsCFELXLaulOUXBYqw7QPC8sIAA"; 
        
        const SUPABASE_TABLE_READING = 'reading_list';
        const SUPABASE_TABLE_TODOS = 'todos';

        let supabase = null;
        let userId = null;
        let readingList = [];
        let todoList = [];
        let expandedTodoParents = new Set();
        
        const readingListElement = document.getElementById('reading-list');
        const todoListElement = document.getElementById('todo-list');
        const dailyFocusListElement = document.getElementById('daily-focus-list');
        const loadingElement = document.getElementById('loading');
        
        function initializeApp() {
            if (SUPABASE_URL.includes("YOUR_DEV_SUPABASE_URL")) {
                loadingElement.innerHTML = `<p class="text-red-500 font-bold text-center">Error: Supabase URL and Key are not set. Please replace the placeholder values in the script.</p>`;
                return;
            }
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            supabase.auth.onAuthStateChange((event, session) => {
                const newUserId = session?.user?.id || null;
                if (newUserId !== userId) {
                    userId = newUserId;
                    handleAuthStateChange(!!userId, session?.user?.email);
                }
            });
        }
        
        async function handleAuthStateChange(isLoggedIn, email) {
            updateAuthButton(!isLoggedIn, email);
            updateFormState(isLoggedIn);
            
            if (isLoggedIn) {
                loadingElement.style.display = 'flex';
                await fetchAndRenderAllLists();
                setupRealtimeListeners();
            } else {
                readingList = [];
                todoList = [];
                expandedTodoParents.clear(); 
                renderAllLists();
                loadingElement.style.display = 'none';
            }
        }

        async function fetchAndRenderAllLists() {
            if (!userId) { 
                renderAllLists(); 
                loadingElement.style.display = 'none';
                return; 
            }
            const [reading, todos] = await Promise.all([
                supabase.from(SUPABASE_TABLE_READING).select('*').eq('user_id', userId),
                supabase.from(SUPABASE_TABLE_TODOS).select('*').eq('user_id', userId)
            ]);
            
            if (reading.error || todos.error) { 
                showModal(`Could not load data.`); 
                loadingElement.style.display = 'none'; 
                return; 
            }
            readingList = reading.data || [];
            todoList = todos.data || [];
            renderAllLists();
            loadingElement.style.display = 'none';
        }

        function setupRealtimeListeners() {
            if (!userId) return;
            supabase.getChannels().forEach(channel => channel.unsubscribe());
            
            supabase.channel('public-changes').on('postgres_changes', 
                { event: '*', schema: 'public', table: SUPABASE_TABLE_READING, filter: `user_id=eq.${userId}` },
                () => fetchAndRenderAllLists()
            ).on('postgres_changes', 
                { event: '*', schema: 'public', table: SUPABASE_TABLE_TODOS, filter: `user_id=eq.${userId}` },
                () => fetchAndRenderAllLists()
            ).subscribe();
        }

        function renderAllLists() {
            renderReadingList();
            renderTodoList();
            renderDailyFocusList();
        }

        function renderReadingList() {
            const list = readingList.sort((a,b) => a.completed - b.completed || a.order - b.order);
            readingListElement.innerHTML = '';
            if (list.length === 0 && userId) { 
                readingListElement.innerHTML = `<p class="text-center py-8 text-gray-500 font-semibold">Your reading list is empty.</p>`;
            } else {
                list.forEach(item => readingListElement.appendChild(createItemElement(item, SUPABASE_TABLE_READING)));
            }
        }
        
        function renderTodoList() {
            todoListElement.innerHTML = '';
            const inboxTodos = todoList.filter(item => !item.parent_id);
            if (inboxTodos.length === 0 && userId) { todoListElement.innerHTML = `<p class="text-center py-8 text-gray-500 font-semibold">You have no tasks!</p>`; }

            const sortedInbox = inboxTodos.sort((a,b) => a.completed - b.completed || a.order - b.order);
            sortedInbox.forEach(mainTodo => {
                const childCount = todoList.filter(t => t.parent_id === mainTodo.id).length;
                const mainLi = createItemElement(mainTodo, SUPABASE_TABLE_TODOS, false, childCount);
                const subtaskContainer = createSubtaskContainer(mainTodo);
                todoListElement.append(mainLi, subtaskContainer);
            });
        }

        function renderDailyFocusList() {
            dailyFocusListElement.innerHTML = '';
            const dailyReading = readingList.filter(item => item.is_daily);
            const dailyTodos = todoList.filter(item => item.is_daily && !item.parent_id);
            // ✅ FIX 1 of 4: Sort the Daily Focus list by its own 'daily_order' column.
            const dailyItems = [...dailyReading, ...dailyTodos].sort((a,b) => (a.daily_order ?? Infinity) - (b.daily_order ?? Infinity));

            if (dailyItems.length === 0 && userId) { dailyFocusListElement.innerHTML = `<p class="text-center py-8 text-gray-500 font-semibold">Drag items here for today.</p>`; }

            dailyItems.forEach(item => {
                const isTodo = 'parent_id' in item;
                const childCount = isTodo ? todoList.filter(t => t.parent_id === item.id).length : 0;
                const tableName = isTodo ? SUPABASE_TABLE_TODOS : SUPABASE_TABLE_READING;
                const mainLi = createItemElement(item, tableName, false, childCount, true);
                dailyFocusListElement.appendChild(mainLi);
                if(isTodo && childCount > 0){
                    const subtaskContainer = createSubtaskContainer(item);
                    dailyFocusListElement.appendChild(subtaskContainer);
                }
            });
        }

        function createSubtaskContainer(mainTodo) {
            const subtaskContainer = document.createElement('div');
            subtaskContainer.className = 'subtask-container hidden';
            subtaskContainer.dataset.parentId = mainTodo.id;
            const children = todoList.filter(t => t.parent_id === mainTodo.id);
            children.sort((a,b) => a.completed - b.completed || a.order - b.order).forEach(subtask => {
                subtaskContainer.appendChild(createItemElement(subtask, SUPABASE_TABLE_TODOS, true));
            });
             if (expandedTodoParents.has(mainTodo.id.toString())) {
                subtaskContainer.classList.remove('hidden');
            }
            return subtaskContainer;
        }

function createItemElement(item, tableName, isSubtask = false, childCount = 0, isDailyFocusItem = false) {
            const li = document.createElement('div');
            li.id = `${tableName}-${item.id}`;
            li.dataset.id = item.id;
            li.dataset.table = tableName;
            li.setAttribute('draggable', !item.completed);
            li.className = `bauhaus-item ${item.completed ? 'opacity-50' : ''}`;
            li.dataset.isSubtask = String(isSubtask);
            if (isSubtask) {
                const parent = todoList.find(t => t.id == item.parent_id);
                if (parent) li.dataset.parentId = parent.id;
            }

            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragend', handleDragEnd);
            li.addEventListener('dragenter', handleDragEnter);
            li.addEventListener('dragleave', handleDragLeave);

            const check = document.createElement('div');
            check.className = `bauhaus-checkbox ${item.completed ? 'completed' : ''}`;
            check.innerHTML = item.completed ? '✓' : '';
            check.onclick = () => toggleCompleted(tableName, item.id, !item.completed);
            
            const textSpan = document.createElement('span');
            textSpan.className = `flex-grow font-semibold ${item.completed ? 'line-through' : ''}`;
            if (tableName === SUPABASE_TABLE_READING) {
                textSpan.innerHTML = item.text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            } else {
                textSpan.textContent = item.text;
            }
            
            li.append(check, textSpan);

            // This is the main, always-visible wrapper for ALL right-side buttons
            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'ml-auto flex items-center'; 
            
            // This is the NESTED wrapper for buttons that will be hidden on hover
            const hiddenActions = document.createElement('div');
            hiddenActions.className = 'item-actions flex items-center'; // This has the class to hide it

            if(isDailyFocusItem && !isSubtask){
                const removeButton = document.createElement('button');
                removeButton.className = 'p-1';
                removeButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                removeButton.onclick = () => removeFromDailyFocus(tableName, item.id);
                hiddenActions.append(removeButton); // Add to hidden wrapper
            }

            if (!isSubtask && tableName === SUPABASE_TABLE_TODOS && !item.completed) {
                const addSubtaskButton = document.createElement('button');
                addSubtaskButton.className = 'p-1';
                addSubtaskButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 4v16m8-8H4" /></svg>`;
                addSubtaskButton.onclick = (e) => { e.stopPropagation(); showAddSubtaskInput(item.id); };
                hiddenActions.append(addSubtaskButton); // Add to hidden wrapper
            }

            // --- THIS IS THE CORRECTED LOGIC ---
            if (!isSubtask && childCount > 0) {
                // 1. If it's a parent, create the toggle button
                const toggleButton = document.createElement('button');
                // This class is targeted by your CSS to make it 'lighter'
                toggleButton.className = 'p-1 rounded-full hover:bg-gray-100 transition-colors subtask-toggle-btn';
                const isExpanded = expandedTodoParents.has(item.id.toString());
                toggleButton.innerHTML = `<svg class="h-5 w-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`;
                
                toggleButton.onclick = function() {
                    const parentElement = this.closest('[data-id]');
                    const parentId = parentElement.dataset.id;
                    const subtaskContainer = parentElement.nextElementSibling;
                    if (subtaskContainer?.classList.contains('subtask-container')) {
                        const isNowHidden = subtaskContainer.classList.toggle('hidden');
                        this.querySelector('svg').classList.toggle('rotate-90');
                        if (isNowHidden) {
                            expandedTodoParents.delete(parentId);
                        } else {
                            expandedTodoParents.add(parentId);
                        }
                    }
                };

                // Add the hidden actions FIRST
                buttonsWrapper.append(hiddenActions);
                // Add the visible toggle button SECOND (so it's on the far right)
                buttonsWrapper.appendChild(toggleButton);

            } else {
                // 2. Otherwise (if not a parent), create the delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'p-1';
                deleteButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12" /></svg>`;
                deleteButton.onclick = () => deleteItem(tableName, item.id);
                
                // Add the delete button to the HIDDEN wrapper
                hiddenActions.append(deleteButton);
                // Add the hidden actions (which now contain delete) to the main wrapper
                buttonsWrapper.append(hiddenActions);
            }
            // --- END OF LOGIC ---
            
            // Finally, append the main wrapper to the list item
            li.append(buttonsWrapper);

            return li;
        }

        function showAddSubtaskInput(parentId) {
            const existingInput = document.getElementById('temp-subtask-input-container');
            if (existingInput) existingInput.remove();
            const container = document.querySelector(`.subtask-container[data-parent-id="${parentId}"]`);
            if (!container) return;
            container.classList.remove('hidden');
            const parentLi = container.previousElementSibling;
            if (parentLi) { 
                parentLi.querySelector('.subtask-toggle-btn svg')?.classList.add('rotate-90'); 
                expandedTodoParents.add(parentId.toString());
            }
            const inputContainer = document.createElement('div');
            inputContainer.id = 'temp-subtask-input-container';
            inputContainer.className = 'flex gap-2 p-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Add new sub-task...';
            input.className = 'flex-grow p-2 border-2 border-black';
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'font-semibold bg-primary-yellow text-black p-2 border-2 border-black';
            const saveAndCleanup = async () => {
                if (input.value.trim()) {
                    input.disabled = true; saveButton.disabled = true;
                    await addItem(SUPABASE_TABLE_TODOS, input.value, parentId);
                }
                inputContainer.remove();
            };
            saveButton.onclick = saveAndCleanup;
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') saveAndCleanup();
                if (e.key === 'Escape') inputContainer.remove();
            });
            inputContainer.append(input, saveButton);
            container.appendChild(inputContainer);
            input.focus();
        }
        
        async function addItem(tableName, text, parentId = null) {
    if (!userId || !text.trim()) return;
    const list = tableName === SUPABASE_TABLE_TODOS ? todoList : readingList;
    const itemsToOrder = list.filter(i => (parentId ? i.parent_id === parentId : !i.parent_id));
    const newOrder = itemsToOrder.length > 0 ? Math.max(...itemsToOrder.map(i => i.order || 0)) + 1 : 1;
    const itemToAdd = { user_id: userId, text: text.trim(), completed: false, order: newOrder, is_daily: false, daily_order: null };
    if (tableName === SUPABASE_TABLE_TODOS) { itemToAdd.parent_id = parentId; }

    const { data, error } = await supabase.from(tableName).insert(itemToAdd).select().single();
    if (error) {
        console.error('Failed to add item', error);
        showModal('Failed to add item.');
        return;
    }

    // Immediately refresh local data so the UI updates without a manual refresh.
    await fetchAndRenderAllLists();
}


        async function toggleCompleted(tableName, id, status) {
    if (!userId) return;
    const { error } = await supabase.from(tableName).update({ completed: status }).eq('id', id);
    if (error) {
        console.error('toggleCompleted error', error);
        showModal('Could not update item.');
    } else {
        await fetchAndRenderAllLists();
    }
}

async function deleteItem(tableName, id) {
    if (!userId) return;
    try {
        if (tableName === SUPABASE_TABLE_TODOS) {
            // delete subtasks first
            const { error: errChild } = await supabase.from(tableName).delete().eq('parent_id', id);
            if (errChild) throw errChild;
        }
        const { error } = await supabase.from(tableName).delete().eq('id', id);
        if (error) throw error;
        await fetchAndRenderAllLists();
    } catch (err) {
        console.error('deleteItem error', err);
        showModal('Could not delete item.');
    }
}

async function removeFromDailyFocus(tableName, id){
    if (!userId) return;
    const { error } = await supabase.from(tableName).update({ is_daily: false, daily_order: null }).eq('id', id);
    if (error) {
        console.error('removeFromDailyFocus error', error);
        showModal('Could not remove from Daily Focus.');
    } else {
        await fetchAndRenderAllLists();
    }
}


        let draggedItem = null;
        function handleDragStart(e) { draggedItem = this; setTimeout(() => this.classList.add('drag-source'), 0); }
        function handleDragEnd() {
            draggedItem?.classList.remove('drag-source');
            document.querySelectorAll('.drag-over-indicator, .subtask-drop-active').forEach(el => {
                el.classList.remove('subtask-drop-active');
                if (el.classList.contains('drag-over-indicator')) el.remove();
            });
            draggedItem = null;
        }
        function handleDragLeave(e) {
             const target = e.target.closest('.subtask-container, .bauhaus-item');
             if(target && target.classList.contains('subtask-drop-active')) {
                target.classList.remove('subtask-drop-active');
             }
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            if (!draggedItem) return;
            const dropTarget = e.target.closest('.list-container, .subtask-container, .bauhaus-item');
            if (!dropTarget) return;
            document.querySelectorAll('.subtask-drop-active').forEach(el => el.classList.remove('subtask-drop-active'));
            const isDraggedSubtask = draggedItem.dataset.isSubtask === 'true';

            if (draggedItem.dataset.table === SUPABASE_TABLE_READING && dropTarget.classList.contains('subtask-container')) {
                dropTarget.classList.add('subtask-drop-active');
                return;
            }

            const container = dropTarget.closest('.list-container, .subtask-container');
            if (!container) return;
            
            if (isDraggedSubtask) {
                if (!container.classList.contains('subtask-container') || container.dataset.parentId !== draggedItem.dataset.parentId) {
                    return;
                }
            }

            const targetEl = e.target.closest('[draggable="true"]');
            const indicator = document.querySelector('.drag-over-indicator') || document.createElement('div');
            indicator.className = 'drag-over-indicator';
            
            if (targetEl?.parentNode === container) {
                const rect = targetEl.getBoundingClientRect();
                if (e.clientY - rect.top < rect.height / 2) container.insertBefore(indicator, targetEl);
                else container.insertBefore(indicator, targetEl.nextSibling);
            } else if (container.classList.contains('list-container') || container.classList.contains('subtask-container')) {
                container.appendChild(indicator);
            }
        }

async function handleDrop(e) {
    e.preventDefault();
    if (!draggedItem) { return handleDragEnd(); }

    const dropTarget = e.target.closest('.list-container, .subtask-container');
    if (!dropTarget) { return handleDragEnd(); }

    const isDailyDrop = !!dropTarget.closest('#daily-focus-column');
    const isDailyDrag = !!draggedItem.closest('#daily-focus-column');

    const draggedId = draggedItem.dataset.id;
    const draggedTable = draggedItem.dataset.table;

    document.body.style.pointerEvents = 'none';
    console.debug('handleDrop start', { draggedId, draggedTable, isDailyDrop, isDailyDrag });

    try {
        // Case: reading item -> subtask on a todo's subtask container
        if (draggedTable === SUPABASE_TABLE_READING && dropTarget.classList.contains('subtask-container')) {
            const parentId = dropTarget.dataset.parentId;
            const readingItem = readingList.find(i => String(i.id) === String(draggedId));
            if (readingItem && parentId) {
                const cleanText = readingItem.text.replace(/\*([^*]+)\*/g, '$1');
                await addItem(SUPABASE_TABLE_TODOS, `From reading: ${cleanText}`, parentId);
            }
        } 
        // Standard drop within/between lists
        else if (dropTarget.classList.contains('list-container') || dropTarget.classList.contains('subtask-container')) {
            const promises = [];

            // If moved between daily/non-daily, update is_daily flag for dragged item
            if (isDailyDrop !== isDailyDrag) {
                promises.push(
                    supabase.from(draggedTable).update({ is_daily: isDailyDrop }).eq('id', draggedId)
                );
            }

            // Move DOM node
            const indicator = dropTarget.querySelector('.drag-over-indicator');
            if (indicator) dropTarget.insertBefore(draggedItem, indicator);
            else dropTarget.appendChild(draggedItem);

            // Gather all real items in container
            const itemEls = Array.from(dropTarget.querySelectorAll('[data-id][data-table]'));

            console.debug('Persisting order for', itemEls.map((el, i) => ({
                idx: i, id: el.dataset.id, table: el.dataset.table
            })));

            // Persist order/daily_order for each item
            for (let i = 0; i < itemEls.length; i++) {
                const el = itemEls[i];
                const id = el.dataset.id;
                const table = el.dataset.table;
                if (!id || !table) continue;

                const updateData = isDailyDrop ? { daily_order: i } : { order: i };
                promises.push(supabase.from(table).update(updateData).eq('id', id));
            }

            await Promise.all(promises);
        }
    } catch (error) {
        console.error("Drop operation failed:", error);
        showModal("An error occurred while saving the new order.");
    } finally {
        handleDragEnd();
        document.body.style.pointerEvents = 'auto';
        await fetchAndRenderAllLists();
        console.debug('handleDrop finished');
    }
}

        // --- Helper Functions and Event Listeners ---
        function updateAuthButton(isLoggedOut, email) { const btn = document.getElementById('auth-toggle-btn'); btn.textContent = isLoggedOut ? 'Login' : `Logged in`; }
        function updateFormState(isLoggedIn) { document.querySelectorAll('#add-reading-form input, #add-reading-form button, #add-todo-form input, #add-todo-form button').forEach(el => el.disabled = !isLoggedIn); document.getElementById('new-reading-text').placeholder = isLoggedIn ? "Author (Year): *Title*" : "Please log in"; document.getElementById('new-todo-text').placeholder = isLoggedIn ? "Buy milk, etc." : "Please log in"; }
        async function handleAuthSubmit(e) { e.preventDefault(); const email = document.getElementById('auth-email').value, password = document.getElementById('auth-password').value; const { error } = await supabase.auth.signInWithPassword({ email, password }); if (error) document.getElementById('auth-message').textContent = error.message; else closeAuthModal(); }
        async function handleLogout() { await supabase.auth.signOut(); }
        document.getElementById('auth-toggle-btn').addEventListener('click', async () => {
             const { data: { session } } = await supabase.auth.getSession();
             if (session) {
                 await handleLogout();
             } else {
                 openAuthModal();
             }
        });
        function openAuthModal() { document.getElementById('auth-modal').style.display = 'flex'; }
        function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }
        function showModal(message) { document.getElementById('modal-text').textContent = message; document.getElementById('message-area').style.display = 'flex'; }
        function closeModal() { document.getElementById('message-area').style.display = 'none'; }
        Object.assign(window, { handleAuthSubmit, openAuthModal, closeModal, closeAuthModal });
        ['dragover'].forEach(evt => document.body.addEventListener(evt, e => e.preventDefault()));
        document.body.addEventListener('drop', handleDrop);
        document.getElementById('add-reading-form').addEventListener('submit', e => { 
            e.preventDefault(); 
            const input = document.getElementById('new-reading-text');
            addItem(SUPABASE_TABLE_READING, input.value); 
            input.value = '';
        });
        document.getElementById('add-todo-form').addEventListener('submit', e => { 
            e.preventDefault(); 
            const input = document.getElementById('new-todo-text');
            addItem(SUPABASE_TABLE_TODOS, input.value); 
            input.value = '';
        });
        const readingListDropZone = document.getElementById('reading-column');
        ['dragenter', 'dragover'].forEach(evt => readingListDropZone.addEventListener(evt, e => { e.preventDefault(); if (e.dataTransfer?.types?.includes('Files')) readingListDropZone.classList.add('file-drag-active'); }));
        ['dragleave', 'drop'].forEach(evt => readingListDropZone.addEventListener(evt, e => { e.preventDefault(); readingListDropZone.classList.remove('file-drag-active'); }));
        readingListDropZone.addEventListener('drop', async e => {
            e.preventDefault(); if (!userId) return showModal('Please log in to add to your reading list.');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.pdf')); if (files.length === 0) return;
            for (const file of files) {
                const base = file.name.replace(/\.pdf$/i, ''); const parts = base.split('_');
                if (parts.length < 3) { await addItem(SUPABASE_TABLE_READING, file.name); continue; }
                const authorPart = parts[0], year = parts[1], titleRaw = parts.slice(2).join(' ');
                const authors = authorPart.split('&').map(a => a.split(/[\s-]/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')).join(' & ');
                const title = titleRaw.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                await addItem(SUPABASE_TABLE_READING, `${authors} (${year}): *${title}*`);
            }
        });
        initializeApp();
    </script>
</body>
</html>