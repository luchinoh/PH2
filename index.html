<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading & To-Do Hub</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Fonts and Base Layout */
        body {
            background-color: #F8F7F4; /* Off-white background */
            color: #2c3e50; /* Charcoal text */
            font-family: 'Cormorant Garamond', serif;
            min-height: 100vh;
        }
        .text-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .charcoal-text {
            color: #2c3e50;
        }
        .drag-source {
            opacity: 0.4;
        }
        /* Custom scrollbar for aesthetics */
        .list-container::-webkit-scrollbar {
            width: 8px;
        }
        .list-container::-webkit-scrollbar-thumb {
            background-color: #bdc3c7;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-track {
            background: #F8F7F4;
        }

        /* DND Placeholder for visual feedback */
        .drag-over-indicator {
            border-top: 2px solid #3498db;
            margin-top: -2px;
            height: 0;
        }

        /* Style for drag feedback on the body (for PDFs) */
        .file-drag-active {
            box-shadow: 0 0 0 4px #3498db inset;
        }
    </style>
    <script>
        // Tailwind Configuration for custom colors and fonts
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'off-white': '#F8F7F4',
                        'charcoal': '#2c3e50',
                        'primary-blue': '#3498db', /* for accents/buttons */
                        'primary-green': '#2ecc71', /* for todo accents */
                    },
                    fontFamily: {
                        garamond: ['Cormorant Garamond', 'serif'],
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    maxWidth: {
                        '7xl': '1280px', // Increased max-width for dual pane
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Removed outer border/shadow from this container to let the inner divs handle the 'box' look -->
    <div id="app" class="max-w-7xl mx-auto w-full p-0">
        <h1 class="text-4xl sm:text-5xl font-garamond font-bold mb-8 text-center border-b pb-4 px-4 sm:px-6">
            Productivity Hub
        </h1>

        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center py-10" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue"></div>
            <p class="ml-3 text-poppins text-charcoal">Connecting to Supabase...</p>
        </div>

        <!-- TWO COLUMN LAYOUT (50/50 Width) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 sm:p-6">
            
            <!-- ====== READING LIST COLUMN (50% Width) ====== -->
            <div id="reading-column" class="bg-white rounded-xl shadow-lg p-6 lg:col-span-1 flex flex-col">
                <h2 class="text-3xl font-garamond font-bold mb-4 text-center">Reading List</h2>

                <div id="reading-list" class="list-container flex-grow max-h-[60vh] overflow-y-auto space-y-2 mb-4 p-2 border-b border-gray-100">
                    <!-- Reading List items will be injected here -->
                </div>

                <!-- PDF Drag Hint -->
                <p class="text-poppins text-xs text-center text-gray-400 mb-4 mt-auto">
                    (Drag PDF files anywhere onto the screen to quickly add them.)
                </p>

                <!-- Reading List Add Item Form -->
                <form id="add-reading-form" class="flex space-x-2 pt-4">
                    <input type="text" id="new-reading-text" placeholder="Author (Year): *Title* or drag a PDF"
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue text-poppins charcoal-text">
                    <button type="submit"
                            class="text-poppins font-semibold bg-primary-blue text-white rounded-lg px-4 py-3 shadow-md hover:bg-blue-600 transition duration-200 whitespace-nowrap">
                        Add Text
                    </button>
                </form>
            </div>

            <!-- ====== TO-DO LIST COLUMN (50% Width) ====== -->
            <div id="todo-column" class="bg-white rounded-xl shadow-lg p-6 lg:col-span-1 flex flex-col">
                <h2 class="text-3xl font-garamond font-bold mb-4 text-center">To-Do List</h2>

                <div id="todo-list" class="list-container flex-grow max-h-[60vh] overflow-y-auto space-y-2 mb-4 p-2 border-b border-gray-100">
                    <!-- To-Do List items will be injected here -->
                </div>

                <!-- Empty space placeholder for vertical alignment - Must match height of PDF hint -->
                <div class="h-[3.35rem]"></div> 
                
                <!-- To-Do List Add Item Form -->
                <form id="add-todo-form" class="flex space-x-2 pt-4">
                    <input type="text" id="new-todo-text" placeholder="Buy milk, Study for class, etc."
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-poppins charcoal-text">
                    <button type="submit"
                            class="text-poppins font-semibold bg-primary-green text-white rounded-lg px-4 py-3 shadow-md hover:bg-green-600 transition duration-200 whitespace-nowrap">
                        Add Task
                    </button>
                </form>
            </div>

        </div>
        <!-- END TWO COLUMN LAYOUT -->

        <!-- Message/Modal Area -->
        <div id="message-area" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
            <div id="message-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center text-poppins">
                <p class="charcoal-text font-semibold mb-4" id="modal-text">Error</p>
                <button onclick="closeModal()" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">OK</button>
            </div>
        </div>

    </div>

    <!-- Supabase SDK Imports and Core Logic -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- SUPABASE CONFIGURATION (MUST BE EDITED) ---
        // ðŸš¨ IMPORTANT: Use the SAME keys you configured before!
        const SUPABASE_URL = "https://phpmhqfdbcbpidkohmdx.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBocG1ocWZkYmNicGlka29obWR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTAzOTksImV4cCI6MjA3NDk4NjM5OX0.taS3tmL_OhJ2ubtCthp2HfLV6-1HvfjuU32aekK_kdQ"; 
        // --- END CONFIGURATION ---
        
        const SUPABASE_TABLE_READING = 'reading_list';
        const SUPABASE_TABLE_TODOS = 'todos'; // NEW TABLE NAME

        let supabase = null;
        let userId = null; 
        
        // Separate data arrays
        let readingList = []; 
        let todoList = []; 

        const readingListElement = document.getElementById('reading-list');
        const todoListElement = document.getElementById('todo-list');
        const loadingElement = document.getElementById('loading');
        
        // --- Initialization and Auth ---

        async function initializeSupabase() {
            loadingElement.style.display = 'flex';
            if (SUPABASE_URL === "YOUR_SUPABASE_URL_HERE" || SUPABASE_ANON_KEY === "YOUR_SUPABASE_ANON_KEY_HERE") {
                 showModal("Please update the Supabase configuration with your project keys.");
                 loadingElement.style.display = 'none';
                 return;
            }

            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                supabase.auth.onAuthStateChange((event, session) => {
                    if (session?.user) {
                        userId = session.user.id; 
                        // Setup listeners for BOTH tables
                        setupRealtimeListener(SUPABASE_TABLE_READING);
                        setupRealtimeListener(SUPABASE_TABLE_TODOS);
                    } else {
                        userId = null;
                        readingList = [];
                        todoList = [];
                        renderList(SUPABASE_TABLE_READING);
                        renderList(SUPABASE_TABLE_TODOS);
                        loadingElement.style.display = 'none';
                    }
                });

                const { data: { session } = {} } = await supabase.auth.getSession();
                
                if (!session) {
                    const { error } = await supabase.auth.signInAnonymously();
                    if (error) throw error;
                }

            } catch (error) {
                console.error("Supabase initialization or anonymous sign-in failed:", error);
                showModal("Failed to connect to Supabase Auth. Check console for details.");
                loadingElement.style.display = 'none';
            }
        }


        // --- Utility Functions ---

        window.showModal = function(message) {
            document.getElementById('modal-text').textContent = message;
            document.getElementById('message-area').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('message-area').style.display = 'none';
        }

        function parsePdfFilename(filename) {
            const baseName = filename.replace(/\.pdf$/i, '').trim();
            const match = baseName.match(/^(.+)_(\d{4})_(.+)$/);

            if (match) {
                const author = match[1].replace(/_/g, ' ').trim();
                const year = match[2];
                let title = match[3].replace(/_/g, ' ').trim();
                title = title.charAt(0).toUpperCase() + title.slice(1);
                return `${author} (${year}): *${title}*`;
            }
            return baseName; 
        }
        
        // Determines the data array and DOM element based on table name
        function getListResources(tableName) {
            if (tableName === SUPABASE_TABLE_READING) {
                return { list: readingList, element: readingListElement, emptyMessage: 'Your reading list is empty. Add a book or drag a PDF!', primaryColor: 'primary-blue' };
            } else if (tableName === SUPABASE_TABLE_TODOS) {
                return { list: todoList, element: todoListElement, emptyMessage: 'You have no tasks! Add a new to-do item.', primaryColor: 'primary-green' };
            }
            return null;
        }

        // --- Real-time Data Listener and Rendering (Generic) ---

        async function fetchAndRenderList(tableName) {
             if (!userId) {
                loadingElement.style.display = 'none';
                return; 
             }
             
            const { data, error } = await supabase
                .from(tableName)
                .select('*')
                .eq('user_id', userId) 
                .order('order', { ascending: true }); 

            if (error) {
                console.error(`Supabase fetch failed for ${tableName}:`, error);
                showModal(`Could not load ${tableName}. Check RLS policies.`);
                loadingElement.style.display = 'none';
                return;
            }

            // Client-side sorting: completed items at the bottom
            const sortedData = data.sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed - b.completed;
                }
                if (a.order !== b.order) {
                    return a.order - b.order;
                }
                return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
            });

            if (tableName === SUPABASE_TABLE_READING) {
                readingList = sortedData;
            } else {
                todoList = sortedData;
            }

            renderList(tableName);
            loadingElement.style.display = 'none';
        }
        
        function setupRealtimeListener(tableName) {
            if (!userId) return; 
            
            const existingChannel = supabase.getChannels().find(c => c.topic.includes(tableName));
            if (existingChannel) {
                supabase.removeChannel(existingChannel);
            }
            
            supabase.channel(`changes-${tableName}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: tableName, filter: `user_id=eq.${userId}` },
                    (payload) => {
                        // NOTE: This fires on every CRUD event, fixing the delete issue potentially!
                        fetchAndRenderList(tableName);
                    }
                )
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        // Initial fetch after subscription is confirmed
                        fetchAndRenderList(tableName);
                    }
                });
        }


        /** Renders the current state of a list to its respective DOM element. */
        function renderList(tableName) {
            const resources = getListResources(tableName);
            if (!resources) return;

            const { list, element, emptyMessage, primaryColor } = resources;
            element.innerHTML = '';
            
            if (list.length === 0) {
                element.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">${emptyMessage}</p>`;
                return;
            }

            list.forEach((item) => {
                const li = document.createElement('div');
                li.id = `${tableName}-${item.id}`;
                const completedStyle = item.completed ? 'bg-gray-100 hover:shadow-sm opacity-70 cursor-default' : 'bg-off-white hover:shadow-md cursor-grab';

                li.className = `flex items-center p-3 rounded-xl shadow-sm border border-gray-200 transition-shadow duration-300 ${completedStyle}`;
                
                if (!item.completed) {
                    li.setAttribute('draggable', 'true');
                } else {
                    li.setAttribute('draggable', 'false');
                }

                li.dataset.id = item.id;
                li.dataset.order = item.order;
                li.dataset.table = tableName; // Identify the table for DND
                
                // DND Event Listeners
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragenter', handleDragEnter);
                li.addEventListener('dragleave', handleDragLeave);
                li.addEventListener('dragend', handleDragEnd);

                const textSpan = document.createElement('span');
                textSpan.className = `flex-grow mr-4 text-lg font-garamond transition-all duration-300 ${item.completed ? 'line-through text-gray-500' : 'charcoal-text'}`;
                
                // Only Reading List uses italics formatting
                let displayHtml = item.text;
                if (tableName === SUPABASE_TABLE_READING) {
                    displayHtml = item.text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                }
                textSpan.innerHTML = displayHtml; 

                const handle = document.createElement('div');
                handle.className = `text-gray-400 mr-3 text-2xl leading-none transition-colors duration-200 ${item.completed ? 'hidden' : 'cursor-grab hover:text-charcoal hidden sm:block'}`; 
                handle.innerHTML = '&#8801;'; 

                // Checkmark Button (Toggle Completed)
                const toggleButton = document.createElement('button');
                toggleButton.className = `p-3 h-10 w-10 flex items-center justify-center rounded-full text-white transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-${primaryColor} mr-2 ${item.completed ? 'bg-green-500 hover:bg-green-600' : `bg-gray-400 hover:bg-${primaryColor}`}`;
                toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                toggleButton.onclick = () => toggleCompleted(tableName, item.id, !item.completed);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'p-3 h-10 w-10 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-gray-200 transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-300';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-5 3h14" /></svg>`;
                deleteButton.onclick = () => deleteItem(tableName, item.id);

                // Append Order: Handle | Text | Toggle (Done) | Delete
                li.append(handle, textSpan, toggleButton, deleteButton);
                element.appendChild(li);
            });
        }

        // --- CRUD Operations (Generic) ---

        async function addItem(tableName, text) {
            if (!supabase || !userId || !text.trim()) {
                if (!userId) showModal("Authentication not ready. Please wait for sign-in.");
                return;
            }
            
            const resources = getListResources(tableName);
            if (!resources) return;
            const currentList = resources.list;

            // Determine the next order number among incomplete items
            const incompleteItems = currentList.filter(item => !item.completed);
            const newOrder = incompleteItems.length > 0 ? incompleteItems[incompleteItems.length - 1].order + 1 : 1;
            
            const { error } = await supabase
                .from(tableName)
                .insert({
                    user_id: userId, 
                    text: text.trim(),
                    completed: false,
                    order: newOrder,
                });

            if (error) {
                console.error(`Error adding item to ${tableName}: `, error);
                showModal(`Failed to add item to ${tableName}. Check RLS policies.`);
            } else {
                if (tableName === SUPABASE_TABLE_READING) {
                    document.getElementById('new-reading-text').value = '';
                } else {
                    document.getElementById('new-todo-text').value = '';
                }
            }
        }

        async function toggleCompleted(tableName, id, status) {
            if (!supabase || !userId) return;

            const { error } = await supabase
                .from(tableName)
                .update({ completed: status })
                .eq('id', id);

            if (error) {
                console.error(`Error updating item status in ${tableName}: `, error);
                showModal("Failed to update item status.");
            }
        }

        async function deleteItem(tableName, id) {
            if (!supabase || !userId) return;

            const { error } = await supabase
                .from(tableName)
                .delete()
                .eq('id', id);
            
            if (error) {
                console.error(`Error deleting item from ${tableName}: `, error);
                showModal("Failed to delete item.");
            }
            // Realtime listener handles re-render instantly now
        }

        async function updateItemOrder(tableName, newOrderList) {
            if (!supabase || !userId) return;

            const incompleteOrderList = newOrderList.filter(item => !item.completed);

            const updates = incompleteOrderList.map((item, index) => ({
                id: item.id,
                order: index + 1 
            }));

            const { error } = await supabase
                .from(tableName)
                .upsert(updates, { onConflict: 'id' });

            if (error) {
                console.error(`Supabase batch update failed for ${tableName}:`, error);
                showModal("Failed to save new list order.");
            }
        }

        // --- Drag and Drop Logic (List Reordering) ---

        let draggedItem = null;
        let originalParent = null;

        function handleDragStart(e) {
            if (this.getAttribute('draggable') === 'false') {
                e.preventDefault();
                return;
            }

            draggedItem = this;
            originalParent = this.parentNode;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            
            setTimeout(() => {
                this.classList.add('drag-source');
            }, 0);
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = this;

            // Only allow dropping within the same list/table and on non-completed items
            if (target === draggedItem || target.dataset.id === undefined || target.classList.contains('bg-gray-100') || target.dataset.table !== draggedItem.dataset.table) {
                return;
            }

            originalParent.querySelectorAll('.drag-over-indicator').forEach(el => el.remove());

            const indicator = document.createElement('div');
            indicator.className = 'drag-over-indicator';
            
            const rect = target.getBoundingClientRect();
            const offsetY = e.clientY - rect.top;

            if (offsetY < rect.height / 2) {
                originalParent.insertBefore(indicator, target);
            } else {
                originalParent.insertBefore(indicator, target.nextSibling);
            }
        }

        function handleDragLeave() { /* Handled by dragEnter cleanup */ }
        
        function handleDragEnd() {
            this.classList.remove('drag-source');
            originalParent.querySelectorAll('.drag-over-indicator').forEach(el => el.remove());

            if (originalParent) {
                const children = Array.from(originalParent.children).filter(el => el.dataset.id);
                
                const currentList = originalParent.id === 'reading-list' ? readingList : todoList;
                const tableName = originalParent.id === 'reading-list' ? SUPABASE_TABLE_READING : SUPABASE_TABLE_TODOS;

                const newOrderList = children.map(domEl => {
                    const itemData = currentList.find(item => item.id.toString() === domEl.dataset.id);
                    return itemData || { id: domEl.dataset.id, completed: false };
                });
                
                updateItemOrder(tableName, newOrderList);
            }
            draggedItem = null;
            originalParent = null;
        }

        // Global DND listeners for list reordering
        [readingListElement, todoListElement].forEach(listEl => {
            listEl.addEventListener('dragover', (e) => {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = 'move';
            });

            listEl.addEventListener('drop', (e) => {
                e.preventDefault();
                const indicator = listEl.querySelector('.drag-over-indicator');

                if (draggedItem && indicator && indicator.parentNode === listEl) {
                    indicator.insertAdjacentElement('beforebegin', draggedItem);
                }
            });
        });


        // --- PDF Drag and Drop Handling (Global) ---

        let dragCounter = 0;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        document.body.addEventListener('dragenter', (e) => {
            dragCounter++;
            if (e.dataTransfer.items && e.dataTransfer.items.length) {
                 document.body.classList.add('file-drag-active');
            }
        }, false);
        
        document.body.addEventListener('dragleave', (e) => {
            dragCounter--;
            if (dragCounter === 0) {
                document.body.classList.remove('file-drag-active');
            }
        }, false);

        document.body.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            document.body.classList.remove('file-drag-active');
            dragCounter = 0;

            const files = e.dataTransfer.files;

            if (files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type === 'application/pdf') {
                    const parsedText = parsePdfFilename(file.name);
                    // PDFs only go to the Reading List
                    addItem(SUPABASE_TABLE_READING, parsedText); 
                } else {
                    showModal(`File type not supported for ${file.name}. Only PDF files are accepted for the Reading List.`);
                }
            }
        }


        // --- Event Listeners and Initial Load ---

        document.getElementById('add-reading-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-reading-text');
            addItem(SUPABASE_TABLE_READING, input.value);
        });

        document.getElementById('add-todo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-todo-text');
            addItem(SUPABASE_TABLE_TODOS, input.value); // Add item to the new todos table
        });

        window.onload = initializeSupabase;

    </script>
</body>
</html>
