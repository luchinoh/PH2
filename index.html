<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading & To-Do Hub</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #F8F7F4; color: #2c3e50; font-family: 'Cormorant Garamond', serif; min-height: 100vh; }
        .text-poppins { font-family: 'Poppins', sans-serif; }
        .drag-source { opacity: 0.4; }
        .list-container::-webkit-scrollbar { width: 8px; }
        .list-container::-webkit-scrollbar-thumb { background-color: #bdc3c7; border-radius: 4px; }
        .drag-over-indicator { border-top: 2px solid #3498db; margin-top: -2px; height: 0; }
        .file-drag-active { box-shadow: 0 0 0 4px #3498db inset; }
        .subtask-container { padding-left: 2.5rem; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'off-white': '#F8F7F4', 'charcoal': '#2c3e50', 'primary-blue': '#3498db', 'primary-green': '#2ecc71' },
                    fontFamily: { garamond: ['Cormorant Garamond', 'serif'], poppins: ['Poppins', 'sans-serif'] },
                    maxWidth: { '7xl': '1280px' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto w-full flex justify-end mb-4 px-4 sm:px-6">
        <button id="auth-toggle-btn" class="text-poppins text-xs font-semibold py-2 px-4 rounded-full bg-charcoal text-white hover:bg-gray-700 transition" onclick="openAuthModal()">Login</button>
    </div>

    <div id="app" class="max-w-7xl mx-auto w-full p-0">
        <h1 class="text-4xl sm:text-5xl font-garamond font-bold mb-8 text-center border-b pb-4 px-4 sm:px-6">Productivity Hub</h1>
        <div id="loading" class="flex justify-center items-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue"></div><p class="ml-3 text-poppins">Connecting...</p></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 sm:p-6">
            
            <div id="reading-column" class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                <h2 class="text-3xl font-garamond font-bold mb-4 text-center">Reading List</h2>
                <div id="reading-list" class="list-container flex-grow max-h-[80vh] overflow-y-auto space-y-2 mb-4 p-2 border-b"></div>
                <div class="h-[1.75rem] mb-4 mt-auto"></div>
                <form id="add-reading-form" class="flex space-x-2 pt-4"><input type="text" id="new-reading-text" placeholder="Add..." class="flex-grow p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue text-poppins"><button type="submit" class="text-poppins font-semibold bg-primary-blue text-white rounded-lg px-4 py-3 shadow-md hover:bg-blue-600 transition">Add Text</button></form>
            </div>

            <div class="flex flex-col gap-4">
                <div id="daily-focus-column" class="bg-white rounded-xl shadow-lg p-6 flex flex-col border-2 border-primary-blue">
                    <h2 class="text-3xl font-garamond font-bold mb-4 text-center">Daily Focus</h2>
                    <div id="daily-focus-list" class="list-container flex-grow max-h-[35vh] overflow-y-auto space-y-2 mb-4 p-2 border-b"></div>
                    <div class="h-[1.75rem] mb-4 mt-auto"></div>
                    <p class="text-center text-sm text-poppins text-gray-500 pt-4">Drag items here to plan your day.</p>
                </div>

                <div id="todo-column" class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <h2 class="text-3xl font-garamond font-bold mb-4 text-center">Task Inbox</h2>
                    <div id="todo-list" class="list-container flex-grow max-h-[35vh] overflow-y-auto space-y-2 mb-4 p-2 border-b"></div>
                    <div class="h-[1.75rem] mb-4 mt-auto"></div>
                    <form id="add-todo-form" class="flex space-x-2 pt-4"><input type="text" id="new-todo-text" placeholder="Add..." class="flex-grow p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-poppins"><button type="submit" class="text-poppins font-semibold bg-primary-green text-white rounded-lg px-4 py-3 shadow-md hover:bg-green-600 transition">Add Task</button></form>
                </div>
            </div>

        </div>
    </div>
    <div id="message-area" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;"><div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center text-poppins"><p class="font-semibold mb-4" id="modal-text"></p><button onclick="closeModal()" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">OK</button></div></div>
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;"><div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-poppins"><h3 class="text-2xl font-bold mb-6 text-center">Log In</h3><form id="auth-form" onsubmit="handleAuthSubmit(event)"><p id="auth-message" class="text-sm text-center text-red-500 mb-4"></p><input type="email" id="auth-email" placeholder="Email" required class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue"><input type="password" id="auth-password" placeholder="Password" required class="w-full p-3 mb-6 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue"><button type="submit" class="w-full bg-primary-blue text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-600 transition">Log In</button><button type="button" onclick="closeAuthModal()" class="w-full mt-3 text-sm text-gray-600 py-2 hover:text-charcoal transition">Cancel</button></form></div></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = "https://uqaxcejfjargwoyvaein.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxYXhjZWpmamFyZ3dveXZhZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxODA5MDEsImV4cCI6MjA3NTc1NjkwMX0.N7fLXEtOhE6cS82KbsCFELXLaulOUXBYqw7QPC8sIAA"; 
        
        const SUPABASE_TABLE_READING = 'reading_list';
        const SUPABASE_TABLE_TODOS = 'todos';

        let supabase = null;
        let userId = null;
        let readingList = [];
        let todoList = [];
        let expandedTodoParents = new Set();

        const readingListElement = document.getElementById('reading-list');
        const todoListElement = document.getElementById('todo-list');
        const dailyFocusListElement = document.getElementById('daily-focus-list');
        const loadingElement = document.getElementById('loading');
        
        async function initializeSupabase() {
            if (SUPABASE_URL.includes("YOUR_DEV_SUPABASE_URL")) {
                loadingElement.innerHTML = `<p class="text-red-500 font-bold text-center text-poppins">Error: Supabase URL and Key are not set. Please replace the placeholder values in the script.</p>`;
                return;
            }

            loadingElement.style.display = 'flex';
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            supabase.auth.onAuthStateChange(async (event, session) => {
                userId = session?.user?.id || null;
                updateAuthButton(!userId, session?.user?.email);
                updateFormState(!!userId);

                if (userId) {
                    await fetchAndRenderAllLists();
                    setupRealtimeListener(SUPABASE_TABLE_READING);
                    setupRealtimeListener(SUPABASE_TABLE_TODOS);
                } else {
                    readingList = [];
                    todoList = [];
                    renderAllLists();
                    loadingElement.style.display = 'none';
                }
            });
        }

        async function fetchAndRenderAllLists() {
            if (!userId) { 
                loadingElement.style.display = 'none'; 
                renderAllLists(); 
                return; 
            }
            const [reading, todos] = await Promise.all([
                supabase.from(SUPABASE_TABLE_READING).select('*').eq('user_id', userId),
                supabase.from(SUPABASE_TABLE_TODOS).select('*').eq('user_id', userId)
            ]);
            
            if (reading.error || todos.error) { 
                showModal(`Could not load data.`); 
                loadingElement.style.display = 'none'; 
                return; 
            }
            readingList = reading.data || [];
            todoList = todos.data || [];
            renderAllLists();
            loadingElement.style.display = 'none';
        }

        function setupRealtimeListener(tableName) {
            if (!userId) return;
            const channelId = `changes-${tableName}-${userId}`;
            if (supabase.getChannels().some(c => c.topic.includes(channelId))) return;
            
            supabase.channel(channelId).on('postgres_changes', 
                { event: '*', schema: 'public', table: tableName, filter: `user_id=eq.${userId}` },
                () => fetchAndRenderAllLists()
            ).subscribe();
        }

        function renderAllLists() {
            renderReadingList();
            renderTodoList();
            renderDailyFocusList();
        }

        function renderReadingList() {
            const list = readingList.sort((a,b) => a.completed - b.completed || a.order - b.order);
            readingListElement.innerHTML = '';
            if (list.length === 0 && userId) { 
                readingListElement.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">Your reading list is empty.</p>`;
            } else {
                list.forEach(item => readingListElement.appendChild(createItemElement(item, SUPABASE_TABLE_READING)));
            }
        }
        
        function renderTodoList() {
            expandedTodoParents = new Set(Array.from(document.querySelectorAll('.subtask-container:not(.hidden)')).map(c => c.dataset.parentId));
            todoListElement.innerHTML = '';
            const inboxTodos = todoList.filter(item => !item.parent_id);
            if (inboxTodos.length === 0 && userId) { todoListElement.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">You have no tasks!</p>`; }

            const sortedInbox = inboxTodos.sort((a,b) => a.completed - b.completed || a.order - b.order);
            sortedInbox.forEach(mainTodo => {
                const childCount = todoList.filter(t => t.parent_id === mainTodo.id).length;
                const mainLi = createItemElement(mainTodo, SUPABASE_TABLE_TODOS, false, childCount);
                const subtaskContainer = createSubtaskContainer(mainTodo);
                todoListElement.append(mainLi, subtaskContainer);
            });
            reExpandSubtasks();
        }

        function renderDailyFocusList() {
            dailyFocusListElement.innerHTML = '';
            const dailyReading = readingList.filter(item => item.is_daily);
            const dailyTodos = todoList.filter(item => item.is_daily && !item.parent_id);
            const dailyItems = [...dailyReading, ...dailyTodos];

            if (dailyItems.length === 0 && userId) { dailyFocusListElement.innerHTML = `<p class="text-center py-8 text-gray-500 text-poppins">Drag items here for today.</p>`; }

            dailyItems.sort((a,b) => (a.order || 0) - (b.order || 0)).forEach(item => {
                 const isTodo = 'parent_id' in item;
                 const childCount = isTodo ? todoList.filter(t => t.parent_id === item.id).length : 0;
                 const tableName = isTodo ? SUPABASE_TABLE_TODOS : SUPABASE_TABLE_READING;
                 const mainLi = createItemElement(item, tableName, false, childCount, true);
                 dailyFocusListElement.appendChild(mainLi);
                 if(isTodo && childCount > 0){
                     const subtaskContainer = createSubtaskContainer(item);
                     dailyFocusListElement.appendChild(subtaskContainer);
                 }
            });
            reExpandSubtasks();
        }

        function reExpandSubtasks(){
             expandedTodoParents.forEach(id => {
                const container = document.querySelector(`.subtask-container[data-parent-id="${id}"]`);
                if (container) {
                    container.classList.remove('hidden');
                    const toggleIcon = container.previousElementSibling?.querySelector('.subtask-toggle-btn svg');
                    if (toggleIcon) toggleIcon.classList.add('rotate-90');
                }
            });
        }

        function createSubtaskContainer(mainTodo) {
            const subtaskContainer = document.createElement('div');
            subtaskContainer.className = 'mt-1 space-y-1 subtask-container hidden';
            subtaskContainer.dataset.parentId = mainTodo.id;
            const children = todoList.filter(t => t.parent_id === mainTodo.id);
            children.sort((a,b) => a.completed - b.completed || a.order - b.order).forEach(subtask => {
                subtaskContainer.appendChild(createItemElement(subtask, SUPABASE_TABLE_TODOS, true));
            });
            return subtaskContainer;
        }

        function createItemElement(item, tableName, isSubtask = false, childCount = 0, isDailyFocusItem = false) {
            const li = document.createElement('div');
            li.id = `${tableName}-${item.id}`;
            li.dataset.id = item.id;
            li.dataset.table = tableName;
            li.dataset.order = item.order;
            li.setAttribute('draggable', !item.completed && !isSubtask);
            li.className = `flex items-center rounded-xl border border-gray-200 transition-shadow duration-300 ${isSubtask ? 'p-2 bg-white' : 'p-3 shadow-sm bg-off-white hover:shadow-md'} ${item.completed ? 'opacity-50' : ''}`;
            li.dataset.isSubtask = String(isSubtask);
            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragend', handleDragEnd);
            li.addEventListener('dragenter', handleDragEnter);
            li.addEventListener('dragleave', handleDragLeave);

            if (!isSubtask && childCount > 0) {
                const toggleButton = document.createElement('button');
                toggleButton.className = 'mr-2 p-1 rounded-full hover:bg-gray-100 transition-colors subtask-toggle-btn';
                toggleButton.innerHTML = `<svg class="h-5 w-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`;
                toggleButton.onclick = function() {
                    const parentElement = this.closest('[data-id]');
                    const subtaskContainer = parentElement.nextElementSibling;
                    if (subtaskContainer?.classList.contains('subtask-container')) {
                        subtaskContainer.classList.toggle('hidden');
                        this.querySelector('svg').classList.toggle('rotate-90');
                    }
                };
                li.appendChild(toggleButton);
            }

            const isReading = tableName === SUPABASE_TABLE_READING;
            const primaryColor = isReading ? 'primary-blue' : 'primary-green';
            const toggleButton = document.createElement('button');
            const sizeClasses = isSubtask ? 'h-5 w-5' : 'h-6 w-6';
            toggleButton.className = `mr-3 flex-shrink-0 ${sizeClasses} flex items-center justify-center rounded-full transition-colors ${item.completed ? `text-white bg-${primaryColor}` : `text-gray-400 border-2 border-gray-300 hover:border-${primaryColor}`}`;
            toggleButton.innerHTML = item.completed ? `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg>` : ``;
            toggleButton.onclick = () => toggleCompleted(tableName, item.id, !item.completed);
            
            const textSpan = document.createElement('span');
            textSpan.className = `flex-grow ${isSubtask ? 'text-base' : (isReading ? 'text-lg' : 'text-xl')} font-garamond ${item.completed ? 'line-through text-gray-500' : ''}`;
            if (isReading) textSpan.innerHTML = item.text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            else textSpan.textContent = item.text;
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'ml-auto flex-shrink-0 p-2 h-7 w-7 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-gray-100 transition';
            deleteButton.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12" /></svg>`;
            deleteButton.onclick = () => deleteItem(tableName, item.id);
            
            li.append(toggleButton, textSpan);
            
            if(isDailyFocusItem && !isSubtask){
                const removeButton = document.createElement('button');
                removeButton.className = 'ml-2 flex-shrink-0 p-2 h-7 w-7 flex items-center justify-center rounded-full text-blue-400 hover:text-blue-600 hover:bg-gray-100 transition';
                removeButton.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                removeButton.onclick = () => removeFromDailyFocus(tableName, item.id);
                li.append(removeButton);
            }

            if (!isSubtask && !isReading && !item.completed) {
                const addSubtaskButton = document.createElement('button');
                addSubtaskButton.className = 'ml-2 flex-shrink-0 p-2 h-8 w-8 flex items-center justify-center rounded-full text-gray-400 hover:text-blue-500 hover:bg-gray-100 transition';
                addSubtaskButton.innerHTML = `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 4v16m8-8H4" /></svg>`;
                addSubtaskButton.onclick = (e) => { e.stopPropagation(); showAddSubtaskInput(item.id); };
                li.append(addSubtaskButton);
            }
            li.append(deleteButton);
            return li;
        }

        function showAddSubtaskInput(parentId) {
            const existingInput = document.getElementById('temp-subtask-input-container');
            if (existingInput) existingInput.remove();
            const container = document.querySelector(`.subtask-container[data-parent-id="${parentId}"]`);
            if (!container) return;
            container.classList.remove('hidden');
            const parentLi = container.previousElementSibling;
            if (parentLi) { parentLi.querySelector('.subtask-toggle-btn svg')?.classList.add('rotate-90'); }
            const inputContainer = document.createElement('div');
            inputContainer.id = 'temp-subtask-input-container';
            inputContainer.className = 'p-2 flex items-center space-x-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Add new sub-task...';
            input.className = 'flex-grow p-2 border rounded-lg text-poppins text-sm';
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'text-poppins text-sm font-semibold bg-primary-blue text-white rounded-lg px-3 py-2';
            const saveAndCleanup = async () => {
                if (input.value.trim()) {
                    input.disabled = true; saveButton.disabled = true;
                    await addItem(SUPABASE_TABLE_TODOS, input.value, parentId);
                }
                inputContainer.remove();
            };
            saveButton.onclick = saveAndCleanup;
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') saveAndCleanup();
                if (e.key === 'Escape') inputContainer.remove();
            });
            inputContainer.append(input, saveButton);
            container.appendChild(inputContainer);
            input.focus();
        }
        
        async function addItem(tableName, text, parentId = null) {
            if (!userId || !text.trim()) return;
            const list = tableName === SUPABASE_TABLE_TODOS ? todoList : readingList;
            const itemsToOrder = list.filter(i => (parentId ? i.parent_id === parentId : !i.parent_id));
            const newOrder = itemsToOrder.length > 0 ? Math.max(...itemsToOrder.map(i => i.order || 0)) + 1 : 1;
            const itemToAdd = { user_id: userId, text: text.trim(), completed: false, order: newOrder, is_daily: false };
            if (tableName === SUPABASE_TABLE_TODOS) { itemToAdd.parent_id = parentId; }
            await supabase.from(tableName).insert(itemToAdd);
        }

        async function toggleCompleted(tableName, id, status) {
            if (!userId) return;
            await supabase.from(tableName).update({ completed: status }).eq('id', id);
        }
        async function deleteItem(tableName, id) {
            if (!userId) return;
            await supabase.from(tableName).delete().eq('id', id);
        }
        
        async function removeFromDailyFocus(tableName, id){
            if (!userId) return;
            const list = tableName === SUPABASE_TABLE_READING ? readingList : todoList;
            const item = list.find(i => i.id == id);
            if(item) item.is_daily = false;
            renderAllLists(); // Optimistic update
            await supabase.from(tableName).update({ is_daily: false }).eq('id', id);
        }

        let draggedItem = null;
        function handleDragStart(e) { draggedItem = this; setTimeout(() => this.classList.add('drag-source'), 0); }
        function handleDragEnd() {
            draggedItem?.classList.remove('drag-source');
            document.querySelectorAll('.drag-over-indicator').forEach(el => el.remove());
            draggedItem = null;
        }
        function handleDragLeave(e) { }
        function handleDragEnter(e) {
            e.preventDefault();
            if (!draggedItem || draggedItem.dataset.isSubtask === 'true') return;
            const container = e.target.closest('.list-container');
            if (!container) return;
            const draggedTable = draggedItem.dataset.table;
            if (container.id === 'daily-focus-list' && !['reading_list', 'todos'].includes(draggedTable)) return;
            if (container.id === 'reading-list' && draggedTable !== 'reading_list') return;
            if (container.id === 'todo-list' && draggedTable !== 'todos') return;
            const target = e.target.closest('[draggable="true"]');
            const indicator = document.querySelector('.drag-over-indicator') || document.createElement('div');
            indicator.className = 'drag-over-indicator';
            indicator.style.borderColor = container.id.includes('daily') ? '#3498db' : '#2ecc71';
            if (target?.parentNode === container) {
                const rect = target.getBoundingClientRect();
                if (e.clientY - rect.top < rect.height / 2) container.insertBefore(indicator, target);
                else container.insertBefore(indicator, target.nextSibling);
            } else { container.appendChild(indicator); }
        }

        async function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return handleDragEnd();
            const dropContainer = e.target.closest('.list-container');
            if (!dropContainer || draggedItem.dataset.isSubtask === 'true') return handleDragEnd();

            const tableName = draggedItem.dataset.table;
            const draggedId = draggedItem.dataset.id;
            const isMovingToDaily = dropContainer.id === 'daily-focus-list';
            const listToCheck = tableName === SUPABASE_TABLE_READING ? readingList : todoList;
            const originalItem = listToCheck.find(i => i.id == draggedId);
            const isLeavingDaily = !isMovingToDaily && originalItem?.is_daily;

            // Optimistic UI update
            if (isMovingToDaily) originalItem.is_daily = true;
            if (isLeavingDaily) originalItem.is_daily = false;

            const indicator = dropContainer.querySelector('.drag-over-indicator');
            if (indicator) {
                const listItems = Array.from(dropContainer.children).filter(el => el.dataset.id && el !== draggedItem);
                listItems.splice(Array.from(indicator.parentNode.children).indexOf(indicator), 0, draggedItem);
                
                listItems.forEach((item, index) => {
                    const list = item.dataset.table === SUPABASE_TABLE_READING ? readingList : todoList;
                    const movedItem = list.find(i => i.id == item.dataset.id);
                    if(movedItem) movedItem.order = index + 1;
                });
            }
            renderAllLists();
            handleDragEnd();

            // Send all updates to Supabase in the background
            if (isMovingToDaily) await supabase.from(tableName).update({ is_daily: true }).eq('id', draggedId);
            if (isLeavingDaily) await supabase.from(tableName).update({ is_daily: false }).eq('id', draggedId);
            
            if (indicator) {
                const updates = listToCheck.map(i => ({ id: i.id, order: i.order }));
                await supabase.from(tableName).upsert(updates);
            }
        }

        // --- Helper Functions and Event Listeners ---
        ['dragover'].forEach(evt => document.body.addEventListener(evt, e => e.preventDefault()));
        document.body.addEventListener('drop', handleDrop);
        // âœ¨ BUG FIX: This line was missing, breaking all buttons. It is now restored.
        Object.assign(window, { handleAuthSubmit, openAuthModal, closeModal, closeAuthModal });
        document.getElementById('add-reading-form').addEventListener('submit', e => { e.preventDefault(); addItem(SUPABASE_TABLE_READING, document.getElementById('new-reading-text').value); });
        document.getElementById('add-todo-form').addEventListener('submit', e => { e.preventDefault(); addItem(SUPABASE_TABLE_TODOS, document.getElementById('new-todo-text').value); });
        const readingListDropZone = document.getElementById('reading-column');
        ['dragenter', 'dragover'].forEach(evt => readingListDropZone.addEventListener(evt, e => { e.preventDefault(); if (e.dataTransfer?.types?.includes('Files')) readingListDropZone.classList.add('file-drag-active'); }));
        ['dragleave', 'drop'].forEach(evt => readingListDropZone.addEventListener(evt, e => { e.preventDefault(); readingListDropZone.classList.remove('file-drag-active'); }));
        readingListDropZone.addEventListener('drop', async e => {
            e.preventDefault(); if (!userId) return showModal('Please log in to add to your reading list.');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.pdf')); if (files.length === 0) return;
            for (const file of files) {
                const base = file.name.replace(/\.pdf$/i, ''); const parts = base.split('_');
                if (parts.length < 3) { await addItem(SUPABASE_TABLE_READING, file.name); continue; }
                const authorPart = parts[0], year = parts[1], titleRaw = parts.slice(2).join(' ');
                const authors = authorPart.split('&').map(a => a.split(/[\s-]/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')).join(' & ');
                const title = titleRaw.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                await addItem(SUPABASE_TABLE_READING, `${authors} (${year}): *${title}*`);
            }
        });
        function updateAuthButton(isLoggedOut, email) { const btn = document.getElementById('auth-toggle-btn'); btn.textContent = isLoggedOut ? 'Login' : `Logged in as ${email}`; btn.onclick = isLoggedOut ? openAuthModal : handleLogout; }
        function updateFormState(isLoggedIn) { document.querySelectorAll('#add-reading-form input, #add-reading-form button, #add-todo-form input, #add-todo-form button').forEach(el => el.disabled = !isLoggedIn); document.getElementById('new-reading-text').placeholder = isLoggedIn ? "Author (Year): *Title*" : "Please log in"; document.getElementById('new-todo-text').placeholder = isLoggedIn ? "Buy milk, etc." : "Please log in"; }
        async function handleAuthSubmit(e) { e.preventDefault(); const email = document.getElementById('auth-email').value, password = document.getElementById('auth-password').value; const { error } = await supabase.auth.signInWithPassword({ email, password }); if (error) document.getElementById('auth-message').textContent = error.message; else closeAuthModal(); }
        async function handleLogout() { await supabase.auth.signOut(); }
        function openAuthModal() { document.getElementById('auth-modal').style.display = 'flex'; }
        function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }
        function showModal(message) { document.getElementById('modal-text').textContent = message; document.getElementById('message-area').style.display = 'flex'; }
        function closeModal() { document.getElementById('message-area').style.display = 'none'; }
        window.onload = initializeSupabase;
    </script>
</body>
</html>

